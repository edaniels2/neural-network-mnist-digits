<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    canvas {
      width: 224px;
      border: 1px solid black;
    }
  </style>
  <script>
    /** @type HTMLCanvasElement */let canvas;
    /** @type CanvasRenderingContext2D */let ctx;

    function initCanvas() {
      canvas = document.querySelector('canvas');
      ctx = canvas.getContext('2d');
      const { top, left } = canvas.getBoundingClientRect();
      canvas.onmousedown = startDraw;
      canvas.onmouseup = endDraw;
    
      function startDraw(event) {
        const { clientX, clientY } = event;
        ctx.moveTo((clientX - top) / 8, (clientY - left) / 8);
        ctx.beginPath();
        canvas.onmousemove = drawSegment;
      }
    
      function drawSegment(event) {
        const { clientX, clientY, buttons } = event;
        if (!(buttons & 1)) {
          return;
        }
        ctx.lineTo((clientX - top) / 8, (clientY - left) / 8);
        ctx.stroke();
      }
    
      function endDraw(event) {
        const { clientX, clientY } = event;
        ctx.lineTo((clientX - top) / 8, (clientY - left) / 8);
        ctx.stroke();
        canvas.onmousemove = null;
        submit();
      }
    }

    function submit() {
      const imageData = ctx.getImageData(0, 0, 28, 28);
      // get the alpha channel
      const bwImage = new Uint8Array(imageData.data.length / 4);
      for (let i = 0; i < imageData.data.length / 4; i++) {
        bwImage[i] = imageData.data[i * 4 + 3];
      }
      fetch('/evaluate', { method: 'POST', body: bwImage })
        .then(res => res.json())
        .then(json => {
          const outputDiv = document.querySelector('span.label');
          outputDiv.textContent = json.result.label;
          console.log(json.result.label, json);
        });
    }

    function clearCanvas() {
      const outputDiv = document.querySelector('span.label');
      outputDiv.textContent = '';
      ctx.clearRect(0, 0, 28, 28);
    }
  </script>
</head>
<body onload="initCanvas()">
  <div>
    <canvas height="28" width="28"></canvas>
    <span class="label"></span>
  </div>
  <div>
    <button onclick="clearCanvas()">clear</button>
  </div>
</body>
</html>